#!/bin/bash
#
# MariaDB Backup Script
#

USER=backup
PASS='{{ mariadb_backup_password }}'
DIR=/var/lib/backup/mediacenter/db
ROTATE=30

PREFIX=backup_

set -o pipefail

cleanup()
{
    find "${DIR}/" -maxdepth 1 -type f -name "${PREFIX}*.sql*" -mtime +${ROTATE} -print0 | xargs -0 -r rm -f
}

mysql -u${USER} -p${PASS} -s -r -N -e 'SHOW DATABASES' | grep -Ev "mysql|information_schema|performance_schema"  | while read dbname
do
  mysqldump -u${USER} -p${PASS} --opt --flush-logs --single-transaction --ignore-table=mysql.event \
    ${dbname} > ${DIR}/${PREFIX}${dbname}_`date +%Y%m%d-%H%M%S`.sql
done

if [ $? -eq 0 ] ; then
    cleanup
fi
