- name: ensure VirtualBox is installed
  dnf: name={{ item }}
  when: ansible_virtualization_role != 'guest'
  with_items:
    - VirtualBox
    - akmod-VirtualBox

- name: ensure vagrant is installed
  dnf: name={{ item }}
  with_items:
    - nfs-utils
    - debootstrap
    - redir
    - vagrant
    - vagrant-libvirt
    - vagrant-libvirt-doc
    - vagrant-lxc
    - lxc-templates

- name: ensure lxc bridge is configured
  lineinfile: dest=/etc/lxc/default.conf
              regexp='^lxc.network.link'
              line='lxc.network.link = virbr0'

- name: ensure no password is required for vagrant-libvirt
  shell: cp /usr/share/vagrant/gems/doc/vagrant-libvirt-*/polkit/10-vagrant-libvirt.rules /usr/share/polkit-1/rules.d/
         creates=/usr/share/polkit-1/rules.d/10-vagrant-libvirt.rules

- name: ensure sudoers file for vagrant is installed
  copy: src=sudoers
        dest=/etc/sudoers.d/vagrant-commands
        owner=root group=root mode=0600

- name: ensure ports for mounting are open in internal zone
  firewalld: service={{ item }} permanent=true zone=internal state=enabled
  with_items:
    - nfs
    - mountd
    - rpc-bind


- name: ensure port 2049/udp for vagrant nfs is open in internal zone
  firewalld: port=2049/udp permanent=true zone=internal state=enabled

- include: plugins.yml
